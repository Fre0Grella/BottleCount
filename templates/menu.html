{% extends "base.html" %}
{% block content %}
<div class="mb-4 flex items-center justify-between flex-wrap gap-3">
  <h1 class="text-xl font-bold">üçπ Drink Menu ‚Äî Configure percentages</h1>
  <button class="btn btn-success" onclick="saveMenu()">üíæ Save Menu</button>
</div>

{% if errors %}
<div class="card p-3 mb-4" style="border-color:#ef4444">
  {% for e in errors %}<p class="text-red-400 text-sm">‚ö†Ô∏è {{ e }}</p>{% endfor %}
</div>
{% endif %}

<!-- Catalog data for JS -->
<script>
const CATALOG_COCKTAILS    = {{ catalog.cocktails | tojson }};
const CATALOG_INGREDIENTS  = {{ catalog.ingredients | tojson }};
const SIMPLE_CATEGORIES    = ["Beer", "Wine"];
</script>

<!-- LEVEL 1: macro categories -->
<div class="card p-4 mb-4">
  <h2 class="font-bold text-indigo-300 mb-3">Level 1 ‚Äî Category split</h2>
  <div class="flex flex-wrap gap-6 items-end">
    {% for cat, data in settings.menu.items() %}
    <div>
      <label class="text-xs text-slate-400 block mb-1">{{ cat }}</label>
      <div class="flex items-center gap-1">
        <input type="number" id="macro_{{ cat }}" value="{{ (data.macro_pct * 100)|round(1) }}"
               style="width:70px" min="0" max="100" step="1" oninput="checkSum('macro')">
        <span class="text-slate-400">%</span>
      </div>
    </div>
    {% endfor %}
    <div class="ml-auto text-sm">
      Total: <span id="sum_macro" class="font-bold">
        {{ (settings.menu.values()|map(attribute='macro_pct')|sum * 100)|round(1) }}%
      </span>
    </div>
  </div>
</div>

<!-- Per-category config -->
{% for category, cat_data in settings.menu.items() %}
<div class="card p-4 mb-4">
  <h2 class="font-bold mb-3 flex items-center gap-2">
    {% if category == 'Spirits' %}
      <span class="type-badge type-spirit">{{ category }}</span>
    {% elif category == 'Beer' %}
      <span class="type-badge type-beer">{{ category }}</span>
    {% elif category == 'Wine' %}
      <span class="type-badge type-wine">{{ category }}</span>
    {% else %}
      <span class="text-indigo-300">{{ category }}</span>
    {% endif %}
    <span class="text-sm text-slate-400 font-normal">
      ({{ (cat_data.macro_pct * 100)|round(0)|int }}% of total alcohol)
    </span>
  </h2>

  {% if category in ['Beer', 'Wine'] %}
  <!-- ‚îÄ‚îÄ SIMPLE CATEGORY: just ingredient + % ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <p class="text-xs text-slate-500 mb-3">Served as-is ‚Äî set the share of each variety.</p>
  <div class="space-y-2">
    {% for ing_name, spirit_data in cat_data.spirits.items() %}
    <div class="p-3 rounded-lg flex items-center gap-3 flex-wrap"
         style="background:#252538;border:1px solid #3d3d5c">
      <strong class="text-indigo-200" style="min-width:160px">{{ ing_name }}</strong>
      <input type="number"
             id="pct_spirit_{{ category }}_{{ ing_name|replace(' ','_') }}"
             value="{{ (spirit_data.pct * 100)|round(1) }}"
             style="width:65px" min="0" max="100" step="1"
             oninput="checkSum('spirits_{{ category }}')">
      <span class="text-slate-400">% of {{ category }}</span>
      <button class="btn-danger text-xs ml-auto"
        onclick="removeSpirit('{{ category }}','{{ ing_name }}')">‚úñ Remove</button>
    </div>
    {% endfor %}
  </div>

  <div class="text-sm mt-3">
    Total: <span id="sum_spirits_{{ category }}" class="font-bold">
      {{ (cat_data.spirits.values()|map(attribute='pct')|sum * 100)|round(1) }}%
    </span>
  </div>

  <!-- Add ingredient to simple category -->
  <div class="mt-3 flex gap-2 flex-wrap items-center">
    <select id="sel_spirit_{{ category }}" style="width:220px">
      {% for ing_name, ing in catalog.ingredients.items() %}
        {% if (category == 'Beer' and ing.type == 'beer') or (category == 'Wine' and ing.type == 'wine') %}
          <option value="{{ ing_name }}">{{ ing_name }}</option>
        {% endif %}
      {% endfor %}
    </select>
    <button class="btn btn-primary text-xs" onclick="addSpirit('{{ category }}')">+ Add</button>
  </div>

  {% else %}
  <!-- ‚îÄ‚îÄ SPIRITS CATEGORY: 3-level with cocktail drinks ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div class="space-y-4">
    {% for spirit_name, spirit_data in cat_data.spirits.items() %}
    <div class="p-3 rounded-lg" style="background:#252538;border:1px solid #3d3d5c">
      <div class="flex items-center gap-3 mb-2 flex-wrap">
        <strong class="text-indigo-200">{{ spirit_name }}</strong>
        <div class="flex items-center gap-1">
          <input type="number"
                 id="pct_spirit_{{ category }}_{{ spirit_name|replace(' ','_') }}"
                 value="{{ (spirit_data.pct * 100)|round(1) }}"
                 style="width:65px" min="0" max="100" step="1"
                 oninput="checkSum('spirits_{{ category }}')">
          <span class="text-slate-400">% of {{ category }}</span>
        </div>
        <button class="btn-danger text-xs ml-auto"
          onclick="removeSpirit('{{ category }}','{{ spirit_name }}')">‚úñ Remove</button>
      </div>

      <!-- Drink percentages -->
      <div class="ml-4 space-y-1">
        {% for drink_name, drink_pct in spirit_data.drinks.items() %}
        <div class="flex items-center gap-2">
          <span class="text-sm text-slate-300" style="min-width:170px">{{ drink_name }}</span>
          <input type="number"
                 id="pct_drink_{{ category }}_{{ spirit_name|replace(' ','_') }}_{{ drink_name|replace(' ','_') }}"
                 value="{{ (drink_pct * 100)|round(1) }}"
                 style="width:65px" min="0" max="100" step="1"
                 oninput="checkSum('drinks_{{ category }}_{{ spirit_name|replace(' ','_') }}')">
          <span class="text-slate-400">%</span>
          <button class="btn-danger text-xs"
            onclick="removeDrink('{{ category }}','{{ spirit_name }}','{{ drink_name }}')">‚úñ</button>
        </div>
        {% endfor %}
        <div class="text-xs mt-1">
          Drinks total:
          <span id="sum_drinks_{{ category }}_{{ spirit_name|replace(' ','_') }}" class="font-bold">
            {{ (spirit_data.drinks.values()|sum * 100)|round(1) }}%
          </span>
        </div>
      </div>

      <!-- Add drink ‚Äî only cocktails whose main_spirit matches -->
      <div class="ml-4 mt-2 flex gap-2 flex-wrap items-center">
        <select id="sel_drink_{{ category }}_{{ spirit_name|replace(' ','_') }}" style="width:200px">
          {% for ck_name, ck in catalog.cocktails.items() %}
            {% if ck.main_spirit == spirit_name %}
            <option value="{{ ck_name }}">{{ ck_name }}</option>
            {% endif %}
          {% endfor %}
        </select>
        <button class="btn btn-primary text-xs"
          onclick="addDrink('{{ category }}','{{ spirit_name }}')">+ Add drink</button>
      </div>
      <p class="ml-4 text-xs text-slate-500 mt-1">Only cocktails based on <em>{{ spirit_name }}</em>.</p>
    </div>
    {% endfor %}
  </div>

  <div class="text-sm mt-3">
    Spirits total for {{ category }}:
    <span id="sum_spirits_{{ category }}" class="font-bold">
      {{ (cat_data.spirits.values()|map(attribute='pct')|sum * 100)|round(1) }}%
    </span>
  </div>

  <!-- Add spirit to Spirits category -->
  <div class="mt-3 flex gap-2 flex-wrap items-center">
    <select id="sel_spirit_{{ category }}" style="width:220px">
      {% for ing_name, ing in catalog.ingredients.items() %}
        {% if ing.type == 'spirit' %}
          <option value="{{ ing_name }}">{{ ing_name }}</option>
        {% endif %}
      {% endfor %}
    </select>
    <button class="btn btn-primary text-xs" onclick="addSpirit('{{ category }}')">+ Add spirit</button>
  </div>
  {% endif %}
</div>
{% endfor %}
{% endblock %}

{% block scripts %}
<script>
let menu = {{ settings.menu | tojson }};

function checkSum(scope) {
  if (scope === 'macro') {
    let s = 0;
    Object.keys(menu).forEach(cat => {
      const el = document.getElementById('macro_' + cat);
      if (el) s += parseFloat(el.value || 0);
    });
    const el = document.getElementById('sum_macro');
    if (el) { el.textContent = s.toFixed(1) + '%'; el.className = 'font-bold ' + (Math.abs(s-100)<0.5?'ok':'err'); }

  } else if (scope.startsWith('spirits_')) {
    const cat = scope.replace('spirits_', '');
    let s = 0;
    Object.keys(menu[cat]?.spirits || {}).forEach(sp => {
      const el = document.getElementById('pct_spirit_' + cat + '_' + sp.replace(/ /g,'_'));
      if (el) s += parseFloat(el.value || 0);
    });
    const el = document.getElementById('sum_spirits_' + cat);
    if (el) { el.textContent = s.toFixed(1) + '%'; el.className = 'font-bold ' + (Math.abs(s-100)<0.5?'ok':'err'); }

  } else if (scope.startsWith('drinks_')) {
    const rest    = scope.replace('drinks_', '');
    const cat     = Object.keys(menu).find(c => rest.startsWith(c));
    if (!cat) return;
    const sp_key  = rest.replace(cat + '_', '');
    const sp_name = Object.keys(menu[cat]?.spirits || {}).find(s => s.replace(/ /g,'_') === sp_key);
    if (!sp_name) return;
    let s = 0;
    Object.keys(menu[cat].spirits[sp_name].drinks || {}).forEach(dk => {
      const id = 'pct_drink_' + cat + '_' + sp_key + '_' + dk.replace(/ /g,'_');
      const el = document.getElementById(id);
      if (el) s += parseFloat(el.value || 0);
    });
    const sumEl = document.getElementById('sum_drinks_' + cat + '_' + sp_key);
    if (sumEl) { sumEl.textContent = s.toFixed(1) + '%'; sumEl.className = 'font-bold ' + (Math.abs(s-100)<0.5?'ok':'err'); }
  }
}

function readMenu() {
  const m = JSON.parse(JSON.stringify(menu));
  Object.keys(m).forEach(cat => {
    const macroEl = document.getElementById('macro_' + cat);
    if (macroEl) m[cat].macro_pct = parseFloat(macroEl.value || 0) / 100;

    Object.keys(m[cat].spirits).forEach(sp => {
      const sp_key   = sp.replace(/ /g,'_');
      const spiritEl = document.getElementById('pct_spirit_' + cat + '_' + sp_key);
      if (spiritEl) m[cat].spirits[sp].pct = parseFloat(spiritEl.value || 0) / 100;

      // Only read drink inputs for Spirits (non-simple) categories
      if (!SIMPLE_CATEGORIES.includes(cat)) {
        Object.keys(m[cat].spirits[sp].drinks || {}).forEach(dk => {
          const id = 'pct_drink_' + cat + '_' + sp_key + '_' + dk.replace(/ /g,'_');
          const el = document.getElementById(id);
          if (el) m[cat].spirits[sp].drinks[dk] = parseFloat(el.value || 0) / 100;
        });
      }
    });
  });
  return m;
}

async function saveMenu() {
  const m = readMenu();
  const r = await apiPost('/api/menu', {menu: m});
  if (r.ok) { alert('‚úÖ Menu saved!'); location.reload(); }
  else alert('‚ùå Errors:\n' + r.errors.join('\n'));
}

async function addDrink(cat, spirit) {
  const selId = 'sel_drink_' + cat + '_' + spirit.replace(/ /g,'_');
  const sel   = document.getElementById(selId);
  if (!sel || !sel.value) { alert('No compatible cocktails found for ' + spirit); return; }
  const dk = sel.value;

  const ck = CATALOG_COCKTAILS[dk];
  if (!ck) { alert('Cocktail not found in catalog'); return; }
  if (ck.main_spirit !== spirit) {
    alert(`"${dk}" is based on "${ck.main_spirit}", not "${spirit}".`);
    return;
  }
  if (menu[cat].spirits[spirit].drinks[dk] !== undefined) {
    alert(dk + ' is already in the list'); return;
  }

  const m = readMenu();
  m[cat].spirits[spirit].drinks[dk] = 0;
  const r = await apiPost('/api/menu', {menu: m, structural: true});
  if (r.ok) location.reload();
  else alert('‚ùå ' + (r.errors || [r.error || 'Unknown error']).join('\n'));
}

async function removeDrink(cat, spirit, drink) {
  const m = readMenu();
  delete m[cat].spirits[spirit].drinks[drink];
  const r = await apiPost('/api/menu', {menu: m, structural: true});
  if (r.ok) location.reload();
  else alert('‚ùå Save failed');
}

async function addSpirit(cat) {
  const sel = document.getElementById('sel_spirit_' + cat);
  if (!sel || !sel.value) { alert('No ingredient selected'); return; }
  const sp = sel.value;
  if (menu[cat]?.spirits?.[sp] !== undefined) { alert(sp + ' is already here'); return; }

  const m = readMenu();
  if (!m[cat]) { alert('Category not found: ' + cat); return; }

  if (SIMPLE_CATEGORIES.includes(cat)) {
    // Beer/Wine: no drinks sublevel
    m[cat].spirits[sp] = { pct: 0 };
  } else {
    m[cat].spirits[sp] = { pct: 0, drinks: {} };
  }

  const r = await apiPost('/api/menu', {menu: m, structural: true});
  if (r.ok) location.reload();
  else alert('‚ùå ' + (r.errors || [r.error || 'Unknown error']).join('\n'));
}

async function removeSpirit(cat, spirit) {
  if (!confirm('Remove ' + spirit + ' from ' + cat + '?')) return;
  const m = readMenu();
  delete m[cat].spirits[spirit];
  const r = await apiPost('/api/menu', {menu: m, structural: true});
  if (r.ok) location.reload();
  else alert('‚ùå Save failed');
}
</script>
{% endblock %}

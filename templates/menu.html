{% extends "base.html" %}
{% block content %}

<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;gap:10px;flex-wrap:wrap;">
  <h1 style="font-size:1.1rem;font-weight:800;">üçπ Drink Menu</h1>
  <button class="btn btn-success btn-sm" onclick="saveMenu()">üíæ Save Menu</button>
</div>

{% if errors %}
<div class="card mb-3" style="padding:12px;border-color:#ef4444;">
  {% for e in errors %}<p style="color:#f87171;font-size:.875rem;margin-bottom:2px;">‚ö†Ô∏è {{ e }}</p>{% endfor %}
</div>
{% endif %}

<script>
const CATALOG_COCKTAILS   = {{ catalog.cocktails | tojson }};
const CATALOG_INGREDIENTS = {{ catalog.ingredients | tojson }};
const SIMPLE_CATEGORIES   = ["Beer", "Wine"];
</script>

<!-- ‚îÄ‚îÄ Level 1: macro split ‚îÄ‚îÄ -->
<div class="card mb-3" style="padding:14px;">
  <div class="section-label" style="margin-bottom:10px;">Category Split (must = 100%)</div>
  <div style="display:flex;flex-wrap:wrap;gap:12px;align-items:flex-end;">
    {% for cat, data in settings.menu.items() %}
    <div style="flex:1;min-width:80px;">
      <label class="section-label" style="margin-bottom:4px;display:block;">{{ cat }}</label>
      <div style="display:flex;align-items:center;gap:4px;">
        <input type="number" id="macro_{{ cat }}"
               value="{{ (data.macro_pct * 100)|round(1) }}"
               min="0" max="100" step="1"
               oninput="checkSum('macro')"
               style="width:100%;">
        <span style="color:#94a3b8;white-space:nowrap;font-size:.85rem;">%</span>
      </div>
    </div>
    {% endfor %}
  </div>
  <div style="margin-top:10px;font-size:.85rem;">
    Total: <span id="sum_macro" class="font-bold ok">
      {{ (settings.menu.values()|map(attribute='macro_pct')|sum * 100)|round(1) }}%
    </span>
  </div>
</div>

<!-- ‚îÄ‚îÄ Per-category config ‚îÄ‚îÄ -->
{% for category, cat_data in settings.menu.items() %}
<div class="card mb-3">
  <button class="collapsible-btn open" onclick="toggleSection(this)">
    <span style="display:flex;align-items:center;gap:8px;">
      {% if category == 'Spirits' %}<span class="type-badge type-spirit">{{ category }}</span>
      {% elif category == 'Beer' %}<span class="type-badge type-beer">{{ category }}</span>
      {% elif category == 'Wine' %}<span class="type-badge type-wine">{{ category }}</span>
      {% else %}<span>{{ category }}</span>{% endif %}
      <span style="font-size:.8rem;color:#94a3b8;font-weight:400;">
        {{ (cat_data.macro_pct * 100)|round(0)|int }}% of total
      </span>
    </span>
    <svg class="chevron" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
  </button>

  <div class="collapsible-body" style="padding:0 14px 14px;">

    {% if category in ['Beer', 'Wine'] %}
    <!-- ‚îÄ‚îÄ Simple: just % per variety ‚îÄ‚îÄ -->
    <p style="font-size:.75rem;color:#64748b;margin-bottom:10px;">Served as-is ‚Äî set the share of each variety (must = 100%)</p>

    {% for ing_name, spirit_data in cat_data.spirits.items() %}
    <div style="background:var(--surface2);border:1px solid var(--border2);border-radius:10px;padding:12px;margin-bottom:8px;">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;">
        <span style="font-weight:600;font-size:.9rem;flex:1;min-width:120px;">{{ ing_name }}</span>
        <button class="btn-danger btn-sm" onclick="removeSpirit('{{ category }}','{{ ing_name }}')">‚úñ Remove</button>
      </div>
      <div style="display:flex;align-items:center;gap:8px;margin-top:8px;">
        <input type="number"
               id="pct_spirit_{{ category }}_{{ ing_name|replace(' ','_') }}"
               value="{{ (spirit_data.pct * 100)|round(1) }}"
               min="0" max="100" step="1"
               oninput="checkSum('spirits_{{ category }}')"
               style="max-width:80px;">
        <span style="color:#94a3b8;font-size:.85rem;">% of {{ category }}</span>
      </div>
    </div>
    {% endfor %}

    <div style="font-size:.85rem;margin-bottom:12px;">
      Total: <span id="sum_spirits_{{ category }}" class="font-bold ok">
        {{ (cat_data.spirits.values()|map(attribute='pct')|sum * 100)|round(1) }}%
      </span>
    </div>

    <!-- Add ingredient -->
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
      <select id="sel_spirit_{{ category }}" style="flex:1;min-width:0;">
        {% for ing_name, ing in catalog.ingredients.items() %}
          {% if (category == 'Beer' and ing.type == 'beer') or (category == 'Wine' and ing.type == 'wine') %}
            <option value="{{ ing_name }}">{{ ing_name }}</option>
          {% endif %}
        {% endfor %}
      </select>
      <button class="btn btn-primary btn-sm" onclick="addSpirit('{{ category }}')">+ Add</button>
    </div>

    {% else %}
    <!-- ‚îÄ‚îÄ Spirits: 3-level ‚îÄ‚îÄ -->
    {% for spirit_name, spirit_data in cat_data.spirits.items() %}
    <div style="background:var(--surface2);border:1px solid var(--border2);border-radius:10px;padding:12px;margin-bottom:10px;">

      <!-- Spirit header -->
      <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;margin-bottom:8px;">
        <span style="font-weight:700;font-size:.95rem;">{{ spirit_name }}</span>
        <button class="btn-danger btn-sm" onclick="removeSpirit('{{ category }}','{{ spirit_name }}')">‚úñ</button>
      </div>
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
        <input type="number"
               id="pct_spirit_{{ category }}_{{ spirit_name|replace(' ','_') }}"
               value="{{ (spirit_data.pct * 100)|round(1) }}"
               min="0" max="100" step="1"
               oninput="checkSum('spirits_{{ category }}')"
               style="max-width:80px;">
        <span style="color:#94a3b8;font-size:.85rem;">% of Spirits</span>
      </div>

      <!-- Drinks -->
      <div style="border-top:1px solid var(--border);padding-top:10px;">
        <div class="section-label" style="margin-bottom:6px;">Cocktails (must = 100%)</div>
        {% for drink_name, drink_pct in spirit_data.drinks.items() %}
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;flex-wrap:wrap;">
          <span style="flex:1;font-size:.85rem;min-width:100px;color:#cbd5e1;">{{ drink_name }}</span>
          <input type="number"
                 id="pct_drink_{{ category }}_{{ spirit_name|replace(' ','_') }}_{{ drink_name|replace(' ','_') }}"
                 value="{{ (drink_pct * 100)|round(1) }}"
                 min="0" max="100" step="1"
                 oninput="checkSum('drinks_{{ category }}_{{ spirit_name|replace(' ','_') }}')"
                 style="max-width:72px;">
          <span style="color:#94a3b8;font-size:.85rem;">%</span>
          <button class="btn-danger btn-sm" onclick="removeDrink('{{ category }}','{{ spirit_name }}','{{ drink_name }}')">‚úñ</button>
        </div>
        {% endfor %}
        <div style="font-size:.8rem;margin-bottom:8px;">
          Total: <span id="sum_drinks_{{ category }}_{{ spirit_name|replace(' ','_') }}" class="font-bold ok">
            {{ (spirit_data.drinks.values()|sum * 100)|round(1) }}%
          </span>
        </div>

        <!-- Add drink -->
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
          <select id="sel_drink_{{ category }}_{{ spirit_name|replace(' ','_') }}" style="flex:1;min-width:0;">
            {% for ck_name, ck in catalog.cocktails.items() %}
              {% if ck.main_spirit == spirit_name %}
              <option value="{{ ck_name }}">{{ ck_name }}</option>
              {% endif %}
            {% endfor %}
          </select>
          <button class="btn btn-primary btn-sm" onclick="addDrink('{{ category }}','{{ spirit_name }}')">+ Add drink</button>
        </div>
      </div>
    </div>
    {% endfor %}

    <div style="font-size:.85rem;margin-bottom:12px;">
      Spirits total: <span id="sum_spirits_{{ category }}" class="font-bold ok">
        {{ (cat_data.spirits.values()|map(attribute='pct')|sum * 100)|round(1) }}%
      </span>
    </div>

    <!-- Add spirit -->
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
      <select id="sel_spirit_{{ category }}" style="flex:1;min-width:0;">
        {% for ing_name, ing in catalog.ingredients.items() %}
          {% if ing.type == 'spirit' %}
            <option value="{{ ing_name }}">{{ ing_name }}</option>
          {% endif %}
        {% endfor %}
      </select>
      <button class="btn btn-primary btn-sm" onclick="addSpirit('{{ category }}')">+ Add spirit</button>
    </div>
    {% endif %}

  </div>
</div>
{% endfor %}

{% endblock %}

{% block scripts %}
<script>
let menu = {{ settings.menu | tojson }};

function checkSum(scope) {
  if (scope === 'macro') {
    let s = 0;
    Object.keys(menu).forEach(cat => {
      const el = document.getElementById('macro_' + cat);
      if (el) s += parseFloat(el.value || 0);
    });
    const el = document.getElementById('sum_macro');
    if (el) { el.textContent = s.toFixed(1) + '%'; el.className = 'font-bold ' + (Math.abs(s-100)<0.5?'ok':'err'); }
  } else if (scope.startsWith('spirits_')) {
    const cat = scope.replace('spirits_', '');
    let s = 0;
    Object.keys(menu[cat]?.spirits || {}).forEach(sp => {
      const el = document.getElementById('pct_spirit_' + cat + '_' + sp.replace(/ /g,'_'));
      if (el) s += parseFloat(el.value || 0);
    });
    const el = document.getElementById('sum_spirits_' + cat);
    if (el) { el.textContent = s.toFixed(1) + '%'; el.className = 'font-bold ' + (Math.abs(s-100)<0.5?'ok':'err'); }
  } else if (scope.startsWith('drinks_')) {
    const rest    = scope.replace('drinks_', '');
    const cat     = Object.keys(menu).find(c => rest.startsWith(c));
    if (!cat) return;
    const sp_key  = rest.replace(cat + '_', '');
    const sp_name = Object.keys(menu[cat]?.spirits || {}).find(s => s.replace(/ /g,'_') === sp_key);
    if (!sp_name) return;
    let s = 0;
    Object.keys(menu[cat].spirits[sp_name].drinks || {}).forEach(dk => {
      const el = document.getElementById('pct_drink_' + cat + '_' + sp_key + '_' + dk.replace(/ /g,'_'));
      if (el) s += parseFloat(el.value || 0);
    });
    const sumEl = document.getElementById('sum_drinks_' + cat + '_' + sp_key);
    if (sumEl) { sumEl.textContent = s.toFixed(1) + '%'; sumEl.className = 'font-bold ' + (Math.abs(s-100)<0.5?'ok':'err'); }
  }
}

function readMenu() {
  const m = JSON.parse(JSON.stringify(menu));
  Object.keys(m).forEach(cat => {
    const macroEl = document.getElementById('macro_' + cat);
    if (macroEl) m[cat].macro_pct = parseFloat(macroEl.value || 0) / 100;
    Object.keys(m[cat].spirits).forEach(sp => {
      const sp_key   = sp.replace(/ /g,'_');
      const spiritEl = document.getElementById('pct_spirit_' + cat + '_' + sp_key);
      if (spiritEl) m[cat].spirits[sp].pct = parseFloat(spiritEl.value || 0) / 100;
      if (!SIMPLE_CATEGORIES.includes(cat)) {
        Object.keys(m[cat].spirits[sp].drinks || {}).forEach(dk => {
          const el = document.getElementById('pct_drink_' + cat + '_' + sp_key + '_' + dk.replace(/ /g,'_'));
          if (el) m[cat].spirits[sp].drinks[dk] = parseFloat(el.value || 0) / 100;
        });
      }
    });
  });
  return m;
}

async function saveMenu() {
  const m = readMenu();
  const r = await apiPost('/api/menu', {menu: m});
  if (r.ok) { alert('‚úÖ Menu saved!'); location.reload(); }
  else alert('‚ùå Errors:\n' + r.errors.join('\n'));
}

async function addDrink(cat, spirit) {
  const sel = document.getElementById('sel_drink_' + cat + '_' + spirit.replace(/ /g,'_'));
  if (!sel || !sel.value) { alert('No compatible cocktails for ' + spirit); return; }
  const dk = sel.value;
  const ck = CATALOG_COCKTAILS[dk];
  if (!ck) { alert('Cocktail not found'); return; }
  if (ck.main_spirit !== spirit) { alert(`"${dk}" is based on "${ck.main_spirit}", not "${spirit}".`); return; }
  if (menu[cat].spirits[spirit].drinks[dk] !== undefined) { alert(dk + ' already added'); return; }
  const m = readMenu();
  m[cat].spirits[spirit].drinks[dk] = 0;
  const r = await apiPost('/api/menu', {menu: m, structural: true});
  if (r.ok) location.reload();
  else alert('‚ùå ' + (r.errors || [r.error || 'Error']).join('\n'));
}

async function removeDrink(cat, spirit, drink) {
  const m = readMenu();
  delete m[cat].spirits[spirit].drinks[drink];
  const r = await apiPost('/api/menu', {menu: m, structural: true});
  if (r.ok) location.reload();
  else alert('‚ùå Save failed');
}

async function addSpirit(cat) {
  const sel = document.getElementById('sel_spirit_' + cat);
  if (!sel || !sel.value) { alert('No ingredient selected'); return; }
  const sp = sel.value;
  if (menu[cat]?.spirits?.[sp] !== undefined) { alert(sp + ' already here'); return; }
  const m = readMenu();
  if (!m[cat]) { alert('Category not found'); return; }
  m[cat].spirits[sp] = SIMPLE_CATEGORIES.includes(cat) ? {pct:0} : {pct:0, drinks:{}};
  const r = await apiPost('/api/menu', {menu: m, structural: true});
  if (r.ok) location.reload();
  else alert('‚ùå ' + (r.errors || [r.error || 'Error']).join('\n'));
}

async function removeSpirit(cat, spirit) {
  if (!confirm('Remove ' + spirit + ' from ' + cat + '?')) return;
  const m = readMenu();
  delete m[cat].spirits[spirit];
  const r = await apiPost('/api/menu', {menu: m, structural: true});
  if (r.ok) location.reload();
  else alert('‚ùå Save failed');
}
</script>
{% endblock %}

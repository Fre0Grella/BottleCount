{% extends "base.html" %}
{% block content %}

<h1 style="font-size:1.1rem;font-weight:800;margin-bottom:12px;">üìö Catalog</h1>

<!-- ‚ïê‚ïê INGREDIENTS ‚ïê‚ïê -->
<div class="card mb-3">
  <button class="collapsible-btn open" onclick="toggleSection(this)">
    üß¥ Ingredients
    <svg class="chevron" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
  </button>
  <div class="collapsible-body" style="padding:0 12px 14px;">

    <!-- Add form (collapsed by default) -->
    <button class="btn btn-primary btn-sm" style="margin-bottom:12px;width:100%;" onclick="toggleAddForm('form_ing')">
      + Add ingredient
    </button>
    <div id="form_ing" style="display:none;background:var(--surface2);border:1px solid var(--border2);border-radius:10px;padding:12px;margin-bottom:12px;">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;">
        <div style="grid-column:1/-1;">
          <label class="section-label" style="display:block;margin-bottom:3px;">Name</label>
          <input type="text" id="ing_name" placeholder="e.g. Rum 70cl">
        </div>
        <div>
          <label class="section-label" style="display:block;margin-bottom:3px;">Type</label>
          <select id="ing_type">
            <option value="spirit">Spirit</option>
            <option value="beer">Beer</option>
            <option value="wine">Wine</option>
            <option value="mixer">Mixer</option>
            <option value="snack">Snack</option>
            <option value="extra">Extra</option>
          </select>
        </div>
        <div>
          <label class="section-label" style="display:block;margin-bottom:3px;">ABV (0.40)</label>
          <input type="number" id="ing_abv" value="0" step="0.01" min="0" max="1">
        </div>
        <div>
          <label class="section-label" style="display:block;margin-bottom:3px;">Volume ml</label>
          <input type="number" id="ing_vol" value="700">
        </div>
        <div>
          <label class="section-label" style="display:block;margin-bottom:3px;">Unit</label>
          <input type="text" id="ing_unit" value="ml">
        </div>
        <div>
          <label class="section-label" style="display:block;margin-bottom:3px;">Min price ‚Ç¨</label>
          <input type="number" id="ing_pmin" value="0" step="0.01">
        </div>
        <div>
          <label class="section-label" style="display:block;margin-bottom:3px;">Max price ‚Ç¨</label>
          <input type="number" id="ing_pmax" value="0" step="0.01">
        </div>
      </div>
      <button class="btn btn-success" style="width:100%;" onclick="addIngredient()">‚úÖ Add ingredient</button>
    </div>

    <!-- Ingredient list as stacked cards -->
    {% for name, ing in catalog.ingredients.items()|sort %}
    <div style="background:var(--surface2);border:1px solid var(--border2);border-radius:10px;padding:12px;margin-bottom:8px;" id="ing_card_{{ loop.index }}">
      <!-- Top row: name + badge + delete -->
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
        <div style="flex:1;min-width:0;">
          <div style="font-weight:700;font-size:.95rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">{{ name }}</div>
          <div style="margin-top:3px;display:flex;align-items:center;gap:6px;flex-wrap:wrap;">
            {% if ing.type == 'spirit' %}<span class="type-badge type-spirit">{{ ing.type }}</span>
            {% elif ing.type == 'beer' %}<span class="type-badge type-beer">{{ ing.type }}</span>
            {% elif ing.type == 'wine' %}<span class="type-badge type-wine">{{ ing.type }}</span>
            {% elif ing.type == 'mixer' %}<span class="type-badge type-mixer">{{ ing.type }}</span>
            {% elif ing.type == 'snack' %}<span class="type-badge type-snack">{{ ing.type }}</span>
            {% else %}<span class="type-badge type-extra">{{ ing.type }}</span>
            {% endif %}
            {% if ing.abv %}<span style="font-size:.75rem;color:#94a3b8;">{{ "%.0f"|format(ing.abv*100) }}% ABV</span>{% endif %}
            {% if ing.volume_ml %}<span style="font-size:.75rem;color:#94a3b8;">{{ ing.volume_ml }}ml</span>{% endif %}
          </div>
        </div>
        <button class="btn-danger btn-sm" onclick="deleteIngredient('{{ name }}')">‚úñ</button>
      </div>
      <!-- Price row: inline editable -->
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
        <div style="display:flex;align-items:center;gap:5px;flex:1;min-width:120px;">
          <span style="font-size:.75rem;color:#4ade80;white-space:nowrap;">Min ‚Ç¨</span>
          <input type="number" step="0.01" min="0"
                 id="pmin_{{ loop.index }}"
                 value="{{ ing.price_min }}"
                 style="flex:1;color:#4ade80;min-width:60px;">
        </div>
        <div style="display:flex;align-items:center;gap:5px;flex:1;min-width:120px;">
          <span style="font-size:.75rem;color:#f87171;white-space:nowrap;">Max ‚Ç¨</span>
          <input type="number" step="0.01" min="0"
                 id="pmax_{{ loop.index }}"
                 value="{{ ing.price_max }}"
                 style="flex:1;color:#f87171;min-width:60px;">
        </div>
        <button class="btn btn-success btn-sm" id="save_btn_{{ loop.index }}"
                onclick="savePrice('{{ name }}', {{ loop.index }})">üíæ</button>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<!-- ‚ïê‚ïê COCKTAILS ‚ïê‚ïê -->
<div class="card mb-3">
  <button class="collapsible-btn open" onclick="toggleSection(this)">
    üç∏ Cocktails
    <svg class="chevron" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
  </button>
  <div class="collapsible-body" style="padding:0 12px 14px;">

    <button class="btn btn-primary btn-sm" style="margin-bottom:12px;width:100%;" onclick="toggleAddForm('form_ck')">
      + Add cocktail
    </button>
    <div id="form_ck" style="display:none;background:var(--surface2);border:1px solid var(--border2);border-radius:10px;padding:12px;margin-bottom:12px;">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;">
        <div style="grid-column:1/-1;">
          <label class="section-label" style="display:block;margin-bottom:3px;">Name</label>
          <input type="text" id="ck_name" placeholder="e.g. Vodka Tonic">
        </div>
        <div>
          <label class="section-label" style="display:block;margin-bottom:3px;">Category</label>
          <select id="ck_cat"><option>Spirits</option></select>
        </div>
        <div>
          <label class="section-label" style="display:block;margin-bottom:3px;">Main spirit</label>
          <select id="ck_spirit">
            {% for name, ing in catalog.ingredients.items() %}
              {% if ing.type == 'spirit' %}
              <option value="{{ name }}">{{ name }}</option>
              {% endif %}
            {% endfor %}
          </select>
        </div>
      </div>
      <!-- Recipe builder -->
      <div class="section-label" style="margin-bottom:6px;">Recipe</div>
      <div id="recipe_rows" style="margin-bottom:8px;"></div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px;">
        <select id="sel_ing_ck" style="flex:1;min-width:0;">
          {% for name in catalog.ingredients.keys() %}
          <option value="{{ name }}">{{ name }}</option>
          {% endfor %}
        </select>
        <input type="number" id="ing_ck_qty" value="50" style="width:64px;">
        <select id="ing_ck_unit" style="width:64px;"><option>ml</option><option>kg</option><option>pcs</option></select>
        <button class="btn btn-primary btn-sm" onclick="addRecipeRow()">+ Add</button>
      </div>
      <button class="btn btn-success" style="width:100%;" onclick="addCocktail()">‚úÖ Create cocktail</button>
    </div>

    <!-- Cocktail list -->
    {% for name, ck in catalog.cocktails.items()|sort %}
    <div style="background:var(--surface2);border:1px solid var(--border2);border-radius:10px;padding:12px;margin-bottom:8px;">
      <div style="display:flex;align-items:flex-start;gap:8px;margin-bottom:6px;">
        <div style="flex:1;min-width:0;">
          <div style="font-weight:700;font-size:.95rem;">{{ name }}</div>
          <div style="margin-top:3px;">
            <span class="type-badge type-spirit">{{ ck.category }}</span>
            <span style="font-size:.75rem;color:#94a3b8;margin-left:6px;">base: {{ ck.main_spirit }}</span>
          </div>
        </div>
        <button class="btn-danger btn-sm" onclick="deleteCocktail('{{ name }}')">‚úñ</button>
      </div>
      <div style="font-size:.75rem;color:#64748b;line-height:1.6;">
        {% for ing, det in ck.recipe.items() %}
          <span style="display:inline-block;background:#1e293b;border-radius:4px;padding:1px 6px;margin:1px;">
            {{ ing }}: {{ det.quantity }}{{ det.unit }}
          </span>
        {% endfor %}
      </div>
    </div>
    {% endfor %}
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let recipe = {};

function toggleAddForm(id) {
  const el = document.getElementById(id);
  el.style.display = el.style.display === 'none' ? 'block' : 'none';
}

function addRecipeRow() {
  const ing  = document.getElementById('sel_ing_ck').value;
  const qty  = parseFloat(document.getElementById('ing_ck_qty').value);
  const unit = document.getElementById('ing_ck_unit').value;
  recipe[ing] = {quantity: qty, unit: unit};
  const row = document.createElement('div');
  row.style.cssText = 'display:flex;align-items:center;gap:6px;margin-bottom:4px;font-size:.85rem;background:#1e293b;border-radius:6px;padding:5px 8px;';
  row.innerHTML = `<span style="flex:1;">${ing}</span><span style="color:#6366f1;">${qty} ${unit}</span><button class="btn-danger btn-sm" onclick="delete recipe['${ing}'];this.parentElement.remove()">‚úñ</button>`;
  document.getElementById('recipe_rows').appendChild(row);
}

async function savePrice(name, idx) {
  const pmin = parseFloat(document.getElementById('pmin_' + idx).value);
  const pmax = parseFloat(document.getElementById('pmax_' + idx).value);
  if (pmin > pmax) { alert('Min cannot exceed max'); return; }
  const r = await apiPost('/api/catalog/ingredient/price', {name, price_min: pmin, price_max: pmax});
  if (r.ok) {
    const btn = document.getElementById('save_btn_' + idx);
    btn.textContent = '‚úÖ';
    setTimeout(() => btn.textContent = 'üíæ', 1400);
  } else { alert('‚ùå ' + (r.error || 'Save failed')); }
}

async function addIngredient() {
  const vol = parseInt(document.getElementById('ing_vol').value);
  const r = await apiPost('/api/catalog/ingredient', {
    name:      document.getElementById('ing_name').value,
    type:      document.getElementById('ing_type').value,
    abv:       parseFloat(document.getElementById('ing_abv').value),
    volume_ml: vol > 0 ? vol : null,
    unit:      document.getElementById('ing_unit').value,
    price_min: parseFloat(document.getElementById('ing_pmin').value),
    price_max: parseFloat(document.getElementById('ing_pmax').value),
  });
  if (r.ok) location.reload();
  else alert('‚ùå ' + r.error);
}

async function deleteIngredient(name) {
  if (!confirm('Delete ' + name + '?')) return;
  const r = await apiDelete('/api/catalog/ingredient/' + encodeURIComponent(name));
  if (r.ok) location.reload();
  else alert('‚ùå ' + (r.error || 'Delete failed'));
}

async function addCocktail() {
  if (Object.keys(recipe).length === 0) { alert('Add at least one ingredient'); return; }
  const r = await apiPost('/api/catalog/cocktail', {
    name:        document.getElementById('ck_name').value,
    category:    document.getElementById('ck_cat').value,
    main_spirit: document.getElementById('ck_spirit').value,
    recipe,
  });
  if (r.ok) location.reload();
  else alert('‚ùå ' + r.error);
}

async function deleteCocktail(name) {
  if (!confirm('Delete ' + name + '?')) return;
  const r = await apiDelete('/api/catalog/cocktail/' + encodeURIComponent(name));
  if (r.ok) location.reload();
  else alert('‚ùå ' + (r.error || 'Delete failed'));
}
</script>
{% endblock %}

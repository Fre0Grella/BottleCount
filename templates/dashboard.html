{% extends "base.html" %}
{% block content %}

<!-- Global parameters -->
<div class="card p-4 mb-4">
  <div class="flex flex-wrap gap-4 items-end">
    <div>
      <label class="text-xs text-slate-400 block mb-1">Guests</label>
      <input type="number" id="guests" value="{{ settings.guests }}" style="width:90px">
    </div>
    <div>
      <label class="text-xs text-slate-400 block mb-1">Ticket ‚Ç¨</label>
      <input type="number" id="ticket_price" value="{{ settings.ticket_price }}" style="width:80px">
    </div>
    <div>
      <label class="text-xs text-slate-400 block mb-1">Venue ‚Ç¨</label>
      <input type="number" id="venue_cost" value="{{ settings.venue_cost }}" style="width:90px">
    </div>
    <div>
      <label class="text-xs text-slate-400 block mb-1">Equipment ‚Ç¨</label>
      <input type="number" id="equipment_cost" value="{{ settings.equipment_cost }}" style="width:90px">
    </div>
    <div style="flex:1;min-width:240px">
      <label class="text-xs text-slate-400 block mb-1">
        Alcohol per person: <strong id="alcohol_label">
          {{ settings.alcohol_ml_per_person }} ml ‚Äî
          {% for ml, name in levels.items() %}{% if ml == settings.alcohol_ml_per_person %}{{ name }}{% endif %}{% endfor %}
        </strong>
      </label>
      <div class="flex items-center gap-2">
        <span class="text-xs">25</span>
        <input type="range" id="alcohol_slider" min="25" max="100" step="25"
               value="{{ settings.alcohol_ml_per_person }}" style="flex:1">
        <span class="text-xs">100</span>
      </div>
      <div class="flex justify-between text-xs mt-1 px-1" style="color:#6366f1">
        {% for ml, name in levels.items() %}<span>{{ name }}</span>{% endfor %}
      </div>
    </div>
    <button class="btn btn-primary" onclick="saveAndReload()">üîÑ Recalculate</button>
    <a href="/api/export" class="btn btn-orange" style="text-decoration:none">üíæ Export TXT</a>
  </div>
</div>

{% if errors %}
<div class="card p-4 mb-4" style="border-color:#ef4444">
  <p class="font-bold text-red-400 mb-2">‚ö†Ô∏è Drink menu errors ‚Äî fix these before calculating:</p>
  {% for e in errors %}<p class="text-red-300 text-sm">‚Ä¢ {{ e }}</p>{% endfor %}
  <a href="/menu" class="btn btn-primary inline-block mt-3" style="text-decoration:none">Go to Drink Menu ‚Üí</a>
</div>
{% endif %}

{% if result %}
<!-- KPI cards -->
<div class="grid gap-3 mb-4" style="grid-template-columns:repeat(auto-fit,minmax(160px,1fr))">
  {% set kpis = [
    ("üí∞ Revenue",    "‚Ç¨ " ~ result.revenue,                                    "#4ade80"),
    ("üí∏ Spend",      "‚Ç¨ " ~ result.total_min ~ " ‚Äì " ~ result.total_max,       "#f87171"),
    ("üè† Fixed costs","‚Ç¨ " ~ result.fixed_costs,                                "#fbbf24"),
    ("üìà Profit",     "‚Ç¨ " ~ result.profit_min ~ " ‚Äì " ~ result.profit_max,     "#34d399"),
    ("‚öñÔ∏è Break-even",  result.break_even ~ " guests",                            "#818cf8"),
  ] %}
  {% for label, val, color in kpis %}
  <div class="card p-3">
    <div class="text-xs text-slate-400">{{ label }}</div>
    <div class="text-lg font-bold mt-1" style="color:{{ color }}">{{ val }}</div>
  </div>
  {% endfor %}
</div>

<div class="grid gap-4" style="grid-template-columns:1fr 1fr">
  <!-- Shopping list table -->
  <div class="card p-4">
    <h2 class="font-bold text-indigo-300 mb-3">üõí Shopping List</h2>
    <table>
      <thead><tr><th>Type</th><th>Item</th><th class="text-right">Qty</th><th class="text-right">Min ‚Ç¨</th><th class="text-right">Max ‚Ç¨</th></tr></thead>
      <tbody>
        {% for r in result.shopping_list %}
        <tr>
          <td><span class="text-xs px-2 rounded" style="background:#2d2d44">{{ r.type }}</span></td>
          <td>{{ r.name }}</td>
          <td class="text-right">{{ r.quantity }} {{ r.unit }}</td>
          <td class="text-right text-green-400">{{ "%.2f"|format(r.cost_min) }}</td>
          <td class="text-right text-red-400">{{ "%.2f"|format(r.cost_max) }}</td>
        </tr>
        {% endfor %}
      </tbody>
      <tfoot>
        <tr style="border-top:2px solid #4d4d6e">
          <td colspan="3" class="font-bold pt-2">TOTAL</td>
          <td class="text-right font-bold text-green-400 pt-2">{{ "%.2f"|format(result.total_min) }}</td>
          <td class="text-right font-bold text-red-400 pt-2">{{ "%.2f"|format(result.total_max) }}</td>
        </tr>
      </tfoot>
    </table>
  </div>

  <!-- Doughnut chart -->
  <div class="card p-4">
    <h2 class="font-bold text-indigo-300 mb-3">üìä Cost Breakdown</h2>
    <canvas id="chartDoughnut" height="260"></canvas>
  </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
const levels = {{ levels | tojson }};

document.getElementById("alcohol_slider").addEventListener("input", function(){
  const v = parseInt(this.value);
  document.getElementById("alcohol_label").innerHTML = v + " ml ‚Äî " + (levels[v] || "");
});

async function saveAndReload(){
  await apiPost("/api/settings", {
    guests:               parseInt(document.getElementById("guests").value),
    ticket_price:         parseFloat(document.getElementById("ticket_price").value),
    venue_cost:           parseFloat(document.getElementById("venue_cost").value),
    equipment_cost:       parseFloat(document.getElementById("equipment_cost").value),
    alcohol_ml_per_person:parseInt(document.getElementById("alcohol_slider").value),
  });
  location.reload();
}

{% if result %}
const byType = {};
{% for r in result.shopping_list %}
  byType["{{ r.type }}"] = (byType["{{ r.type }}"] || 0) + {{ (r.cost_min + r.cost_max) / 2 }};
{% endfor %}
byType["Fixed costs"] = {{ result.fixed_costs }};

new Chart(document.getElementById("chartDoughnut"), {
  type: "doughnut",
  data: {
    labels:   Object.keys(byType),
    datasets: [{
      data: Object.values(byType),
      borderWidth: 2,
      borderColor: "#0f0f1a",
      backgroundColor: ["#6366f1","#22c55e","#f59e0b","#ef4444","#06b6d4","#a855f7","#ec4899","#14b8a6","#f97316"]
    }]
  },
  options: {
    plugins: { legend: { labels: { color:"#e2e8f0", font:{size:12} } } },
    responsive: true,
    maintainAspectRatio: false
  }
});
{% endif %}
</script>
{% endblock %}
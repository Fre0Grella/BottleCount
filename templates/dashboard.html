{% extends "base.html" %}
{% block content %}

<!-- ‚îÄ‚îÄ Settings card ‚îÄ‚îÄ -->
<div class="card mb-3" style="padding:16px">
  <div class="section-label">Party Settings</div>

  <!-- 2-col grid for the 4 number inputs -->
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;">
    <div>
      <label class="section-label" style="margin-bottom:4px;display:block;">Guests</label>
      <input type="number" id="guests" value="{{ settings.guests }}" min="1">
    </div>
    <div>
      <label class="section-label" style="margin-bottom:4px;display:block;">Ticket ‚Ç¨</label>
      <input type="number" id="ticket_price" value="{{ settings.ticket_price }}" min="0" step="0.5">
    </div>
    <div>
      <label class="section-label" style="margin-bottom:4px;display:block;">Venue ‚Ç¨</label>
      <input type="number" id="venue_cost" value="{{ settings.venue_cost }}" min="0">
    </div>
    <div>
      <label class="section-label" style="margin-bottom:4px;display:block;">Equipment ‚Ç¨</label>
      <input type="number" id="equipment_cost" value="{{ settings.equipment_cost }}" min="0">
    </div>
  </div>

  <!-- Alcohol slider ‚Äî full width -->
  <label class="section-label" style="margin-bottom:6px;display:block;">
    Alcohol / person:
    <strong id="alcohol_label" style="color:#e2e8f0;">
      {{ settings.alcohol_ml_per_person }} ml ‚Äî
      {% for ml, name in levels.items() %}{% if ml == settings.alcohol_ml_per_person %}{{ name }}{% endif %}{% endfor %}
    </strong>
  </label>
  <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
    <span style="font-size:.75rem;color:#94a3b8;white-space:nowrap;">25 ml</span>
    <input type="range" id="alcohol_slider" min="25" max="100" step="25"
           value="{{ settings.alcohol_ml_per_person }}">
    <span style="font-size:.75rem;color:#94a3b8;white-space:nowrap;">100 ml</span>
  </div>
  <div style="display:flex;justify-content:space-between;font-size:.7rem;color:#6366f1;padding:0 2px;margin-bottom:14px;">
    {% for ml, name in levels.items() %}<span>{{ name }}</span>{% endfor %}
  </div>

  <div style="display:flex;gap:10px;flex-wrap:wrap;">
    <button class="btn btn-primary" style="flex:1;" onclick="saveAndReload()">üîÑ Recalculate</button>
    <a href="/api/export" class="btn btn-orange" style="flex:1;text-align:center;">üíæ Export</a>
  </div>
</div>

{% if errors %}
<div class="card mb-3" style="padding:14px;border-color:#ef4444;">
  <p style="font-weight:700;color:#f87171;margin-bottom:8px;">‚ö†Ô∏è Menu errors</p>
  {% for e in errors %}<p style="color:#fca5a5;font-size:.875rem;margin-bottom:2px;">‚Ä¢ {{ e }}</p>{% endfor %}
  <a href="/menu" class="btn btn-primary btn-sm" style="text-decoration:none;margin-top:10px;display:inline-flex;">
    Fix Drink Menu ‚Üí
  </a>
</div>
{% endif %}

{% if result %}
<!-- ‚îÄ‚îÄ KPI cards ‚îÄ‚îÄ -->
<div class="grid-kpi mb-3">
  {% set kpis = [
    ("üí∞ Revenue",    "‚Ç¨ " ~ result.revenue,                              "#4ade80"),
    ("üí∏ Spend",      "‚Ç¨" ~ result.total_min ~ "‚Äì" ~ result.total_max,   "#f87171"),
    ("üè† Fixed",      "‚Ç¨ " ~ result.fixed_costs,                         "#fbbf24"),
    ("üìà Profit",     "‚Ç¨" ~ result.profit_min ~ "‚Äì" ~ result.profit_max, "#34d399"),
    ("‚öñÔ∏è Break-even", result.break_even ~ " guests",                      "#818cf8"),
  ] %}
  {% for label, val, color in kpis %}
  <div class="card" style="padding:12px;">
    <div style="font-size:.7rem;color:#94a3b8;margin-bottom:4px;">{{ label }}</div>
    <div style="font-size:.95rem;font-weight:800;color:{{ color }};line-height:1.2;">{{ val }}</div>
  </div>
  {% endfor %}
</div>

<!-- ‚îÄ‚îÄ Shopping list (full width, stacked rows) ‚îÄ‚îÄ -->
<div class="card mb-3">
  <button class="collapsible-btn open" onclick="toggleSection(this)">
    üõí Shopping List
    <svg class="chevron" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
  </button>
  <div class="collapsible-body" style="padding:0 0 4px 0;">
    <!-- Header row -->
    <div style="display:flex;gap:8px;padding:6px 12px;background:#252538;font-size:.7rem;font-weight:700;letter-spacing:.05em;text-transform:uppercase;color:#94a3b8;border-bottom:1px solid #2d2d44;">
      <span style="flex:1;">Item</span>
      <span style="width:52px;text-align:right;">Qty</span>
      <span style="width:52px;text-align:right;color:#4ade80;">Min‚Ç¨</span>
      <span style="width:52px;text-align:right;color:#f87171;">Max‚Ç¨</span>
    </div>
    {% for r in result.shopping_list %}
    <div class="mob-row">
      <div class="mob-name">
        <div class="mob-name-text">{{ r.name }}</div>
        <div style="margin-top:2px;">
          {% if r.type == 'spirit' %}<span class="type-badge type-spirit">{{ r.type }}</span>
          {% elif r.type == 'beer' %}<span class="type-badge type-beer">{{ r.type }}</span>
          {% elif r.type == 'wine' %}<span class="type-badge type-wine">{{ r.type }}</span>
          {% elif r.type == 'mixer' %}<span class="type-badge type-mixer">{{ r.type }}</span>
          {% elif r.type == 'snack' %}<span class="type-badge type-snack">{{ r.type }}</span>
          {% else %}<span class="type-badge type-extra">{{ r.type }}</span>
          {% endif %}
        </div>
      </div>
      <span style="width:52px;text-align:right;font-size:.8rem;white-space:nowrap;">{{ r.quantity }} {{ r.unit }}</span>
      <span style="width:52px;text-align:right;color:#4ade80;font-size:.8rem;">{{ "%.2f"|format(r.cost_min) }}</span>
      <span style="width:52px;text-align:right;color:#f87171;font-size:.8rem;">{{ "%.2f"|format(r.cost_max) }}</span>
    </div>
    {% endfor %}
    <!-- Total row -->
    <div style="display:flex;gap:8px;padding:10px 12px;border-top:2px solid #4d4d6e;font-weight:800;">
      <span style="flex:1;">TOTAL</span>
      <span style="width:52px;"></span>
      <span style="width:52px;text-align:right;color:#4ade80;">{{ "%.2f"|format(result.total_min) }}</span>
      <span style="width:52px;text-align:right;color:#f87171;">{{ "%.2f"|format(result.total_max) }}</span>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ Doughnut chart ‚îÄ‚îÄ -->
<div class="card mb-3">
  <button class="collapsible-btn open" onclick="toggleSection(this)">
    üìä Cost Breakdown
    <svg class="chevron" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
  </button>
  <div class="collapsible-body" style="padding:0 16px 16px;">
    <div style="position:relative;height:260px;">
      <canvas id="chartDoughnut" style="position:absolute;inset:0;width:100%!important;height:100%!important;"></canvas>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
const levels = {{ levels | tojson }};

document.getElementById("alcohol_slider").addEventListener("input", function(){
  const v = parseInt(this.value);
  document.getElementById("alcohol_label").innerHTML = v + " ml ‚Äî " + (levels[v] || "");
});

async function saveAndReload(){
  await apiPost("/api/settings", {
    guests:                parseInt(document.getElementById("guests").value),
    ticket_price:          parseFloat(document.getElementById("ticket_price").value),
    venue_cost:            parseFloat(document.getElementById("venue_cost").value),
    equipment_cost:        parseFloat(document.getElementById("equipment_cost").value),
    alcohol_ml_per_person: parseInt(document.getElementById("alcohol_slider").value),
  });
  location.reload();
}

{% if result %}
const byType = {};
{% for r in result.shopping_list %}
  byType["{{ r.type }}"] = (byType["{{ r.type }}"] || 0) + {{ (r.cost_min + r.cost_max) / 2 }};
{% endfor %}
byType["Fixed costs"] = {{ result.fixed_costs }};

const TYPE_COLORS = {
  spirit: "#f97316", beer: "#facc15", wine: "#c084fc",
  mixer: "#22d3ee", snack: "#86efac", extra: "#94a3b8", "Fixed costs": "#ef4444"
};
const labels    = Object.keys(byType);
const bgColors  = labels.map(l => TYPE_COLORS[l] || "#6366f1");

new Chart(document.getElementById("chartDoughnut"), {
  type: "doughnut",
  data: { labels, datasets: [{ data: Object.values(byType), borderWidth: 2, borderColor: "#0f0f1a", backgroundColor: bgColors }] },
  options: {
    plugins: { legend: { labels: { color:"#e2e8f0", font:{size:11}, boxWidth:12 } } },
    responsive: true,
    maintainAspectRatio: false,
  }
});
{% endif %}
</script>
{% endblock %}
